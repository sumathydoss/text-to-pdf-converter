<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free online text to PDF converter. Convert plain text, HTML, or uploaded files to PDF instantly. No registration required, completely private, and works in your browser.">
    <meta name="keywords" content="text to pdf, pdf converter, text converter, html to pdf, online pdf converter, free pdf converter, convert text to pdf">
    <meta name="author" content="Text to PDF Converter">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    
    <!-- Open Graph Meta Tags for Social Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://text-to-pdf-converter-kappa.vercel.app/">
    <meta property="og:title" content="Free Text to PDF Converter | Convert Instantly Online">
    <meta property="og:description" content="Convert text, HTML, and files to PDF in seconds. Fast, secure, and completely free. No downloads or registration needed.">
    <meta property="og:image" content="https://text-to-pdf-converter-kappa.vercel.app/og-image.jpg">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Free Text to PDF Converter | Convert Instantly Online">
    <meta name="twitter:description" content="Convert text, HTML, and files to PDF in seconds. Fast, secure, and completely free.">
    <meta name="twitter:image" content="https://text-to-pdf-converter-kappa.vercel.app/og-image.jpg">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://text-to-pdf-converter-kappa.vercel.app/">
    
    <title>Free Text to PDF Converter | Convert Text & HTML to PDF Online</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23764ba2'/><text x='50' y='65' font-size='80' font-weight='bold' text-anchor='middle' fill='%23ffffff'>ðŸ“„</text></svg>" type="image/svg+xml">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- JSON-LD Structured Data for Search Engines -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Text to PDF Converter",
        "description": "Free online text to PDF converter. Convert plain text, HTML, or uploaded files to PDF instantly.",
        "url": "https://text-to-pdf-converter-kappa.vercel.app/",
        "applicationCategory": "Utility",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "author": {
            "@type": "Organization",
            "name": "Text to PDF Converter"
        }
    }
    </script>
    
    <!-- Additional FAQPage Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "FAQPage",
        "mainEntity": [
            {
                "@type": "Question",
                "name": "How do I convert text to PDF?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Simply paste your text or upload a file, optionally add a title, and click 'Convert to PDF' to download your file instantly."
                }
            },
            {
                "@type": "Question",
                "name": "Is my data secure?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "Yes, this tool is completely private. All processing happens in your browser. No data is sent to any server."
                }
            },
            {
                "@type": "Question",
                "name": "Do I need to download anything?",
                "acceptedAnswer": {
                    "@type": "Answer",
                    "text": "No, this is a web-based tool. It works directly in your browser without any downloads or registration."
                }
            }
        ]
    }
    </script>

    <style>
        * {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            padding-top: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        }

        .main-container {
            width: 100%;
            max-width: 1200px;
        }

        .card {
            border: none;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-radius: 15px;
            background-color: #ffffff;
        }

        body.dark-mode .card {
            background-color: #2d2d2d;
            color: #e0e0e0;
        }

        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 25px;
            text-align: center;
            border: none;
        }

        body.dark-mode .card-header {
            background: linear-gradient(135deg, #404040 0%, #505050 100%);
        }

        .card-body {
            padding: 25px;
        }

        .input-sections-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .input-section {
            display: flex;
            flex-direction: column;
        }

        .input-section > .form-label {
            margin-bottom: 8px;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .option-section {
            display: flex;
            flex-direction: column;
        }

        .option-section .form-label {
            margin-bottom: 8px;
        }

        .divider-desktop {
            display: none;
        }

        .divider {
            display: none;
        }

        @media (max-width: 768px) {
            .options-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .input-sections-container {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 15px;
            }

            .divider {
                display: block;
            }

            .card-body {
                padding: 20px;
            }
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        body.dark-mode .form-label {
            color: #e0e0e0;
        }

        .form-control, .form-select {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            transition: border-color 0.3s ease;
        }

        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background-color: #3d3d3d;
            border-color: #505050;
            color: #e0e0e0;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        body.dark-mode .form-control:focus,
        body.dark-mode .form-select:focus {
            background-color: #3d3d3d;
            border-color: #667eea;
            color: #e0e0e0;
        }

        .drop-zone {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 25px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8f9ff;
            margin: 0;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        body.dark-mode .drop-zone {
            background-color: #3d3d3d;
            border-color: #764ba2;
        }

        .drop-zone:hover {
            border-color: #764ba2;
            background-color: #f0f2ff;
            transform: translateY(-2px);
        }

        body.dark-mode .drop-zone:hover {
            background-color: #454545;
        }

        .drop-zone.dragover {
            border-color: #764ba2;
            background-color: #f0f2ff;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        body.dark-mode .drop-zone.dragover {
            background-color: #454545;
            box-shadow: 0 5px 20px rgba(118, 75, 162, 0.3);
        }

        .drop-zone i {
            font-size: 28px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .drop-zone p {
            margin: 5px 0;
            font-size: 13px;
        }

        .drop-zone strong {
            display: block;
        }

        body.dark-mode .drop-zone i {
            color: #764ba2;
        }

        .file-input {
            display: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(108, 117, 125, 0.4);
            background-color: #5a6268;
            color: white;
        }

        body.dark-mode .btn-secondary {
            background-color: #505050;
        }

        body.dark-mode .btn-secondary:hover {
            background-color: #404040;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-size: 20px;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        body.dark-mode .theme-toggle {
            background: #3d3d3d;
            color: #ffc107;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }

        .alert {
            border-radius: 8px;
            border: none;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
        }

        body.dark-mode .alert-success {
            background-color: #1e4620;
            color: #85e89d;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
        }

        body.dark-mode .alert-danger {
            background-color: #5a1a1a;
            color: #ff6b6b;
        }

        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        body.dark-mode .alert-info {
            background-color: #1a4d52;
            color: #6dd5e0;
        }

        .divider {
            color: #999;
            margin: 20px 0;
            text-align: center;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background-color: #ddd;
        }

        body.dark-mode .divider::before {
            background-color: #505050;
        }

        .divider span {
            background: white;
            padding: 0 10px;
            position: relative;
            z-index: 1;
        }

        body.dark-mode .divider span {
            background: #2d2d2d;
        }

        #textArea {
            resize: vertical;
            min-height: 250px;
            margin: 0;
        }

        @media (max-width: 768px) {
            #textArea {
                min-height: 200px;
            }
        }

        .file-item {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .file-item {
            background-color: #3d3d3d;
            color: #e0e0e0;
        }

        .file-item i {
            margin-right: 10px;
            color: #667eea;
        }

        .text-muted {
            color: #999 !important;
        }

        body.dark-mode .text-muted {
            color: #aaa !important;
        }

        .spinner-border {
            color: #667eea;
        }

        h1 {
            color: white;
            margin: 0;
            font-weight: 700;
        }

        body.dark-mode h1 {
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle" title="Toggle Dark Mode">
        <i class="bi bi-moon-fill"></i>
    </button>

    <!-- Top Advertisement -->
    <div style="text-align: center; margin: 15px auto; min-height: 90px; width: 100%;">
        <ins class="adsbygoogle"
             style="display:inline-block; width:728px; height:90px; max-width:100%;"
             data-ad-client="ca-pub-3379746510244069"
             data-ad-slot="9953420753"
             data-ad-format="horizontal"
             data-full-width-responsive="true"></ins>
    </div>

    <div class="main-container" style="margin-top: 20px;">
        <div class="card">
            <div class="card-header">
                <h1><i class="bi bi-file-pdf"></i> Text to PDF Converter</h1>
            </div>
            <div class="card-body">
                <div id="alertContainer"></div>

                <!-- Privacy Assurance Message -->
                <div class="alert alert-success d-flex align-items-center mb-3" style="border: 2px solid #28a745; background-color: #d4edda;">
                    <i class="bi bi-shield-check" style="font-size: 18px; color: #28a745; margin-right: 12px; flex-shrink: 0;"></i>
                    <div>
                        <strong style="font-size: 14px;">Your Privacy is Protected</strong>
                        <br>
                        <small>All file uploads and text content are processed entirely in your browser. Nothing is stored on our servers or transmitted to third parties. Your data is completely private and never misused.</small>
                    </div>
                </div>

                <!-- File Upload and Text Area Sections -->
                <div class="input-sections-container">
                    <!-- File Upload Section -->
                    <div class="input-section">
                        <label class="form-label">Upload File (TXT or HTML)</label>
                        <div class="drop-zone" id="dropZone">
                            <i class="bi bi-cloud-arrow-up"></i>
                            <p class="mb-2"><strong>Drag and drop your file here</strong></p>
                            <p class="text-muted mb-0">or click to browse (TXT, HTML)</p>
                        </div>
                        <input type="file" id="fileInput" class="file-input" accept=".txt,.html">
                        <div id="fileList"></div>
                    </div>

                    <!-- Or Text Area Section -->
                    <div class="input-section">
                        <label for="textArea" class="form-label">Paste Text or HTML</label>
                        <textarea class="form-control" id="textArea" rows="6" placeholder="Paste your text or HTML content here..."></textarea>
                    </div>
                </div>

                <!-- Or Divider (Mobile Only) -->
                <div class="divider"><span>OR</span></div>

                <!-- Format Detection and PDF Options -->
                <div class="options-container">
                    <!-- Format Detection -->
                    <div class="option-section">
                        <label class="form-label">Content Type</label>
                        <div class="alert alert-info p-2 mb-0">
                            <small><i class="bi bi-info-circle"></i> <span id="formatDetected">Plain Text</span> (auto-detected)</small>
                        </div>
                    </div>

                    <!-- PDF Title Option -->
                    <div class="option-section">
                        <label for="pdfTitle" class="form-label">PDF Title (Optional)</label>
                        <input type="text" class="form-control" id="pdfTitle" placeholder="Enter PDF title...">
                    </div>
                </div>

                <!-- Buttons -->
                <div class="d-flex gap-2">
                    <button class="btn btn-primary flex-grow-1" id="convertBtn">
                        <i class="bi bi-download"></i> Convert to PDF
                    </button>
                    <button class="btn btn-secondary" id="clearBtn">
                        <i class="bi bi-arrow-clockwise"></i> Clear
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Advertisement -->
    <div style="text-align: center; margin: 15px auto; min-height: 90px; width: 100%;">
        <ins class="adsbygoogle"
             style="display:inline-block; width:728px; height:90px; max-width:100%;"
             data-ad-client="ca-pub-3379746510244069"
             data-ad-slot="9953420753"
             data-ad-format="horizontal"
             data-full-width-responsive="true"></ins>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script type="module">
        import { config } from './config.js';
        window.appConfig = config;
        
        // Dynamically load Google AdSense if enabled
        if (config.ENABLE_ANALYTICS) {
            const script = document.createElement('script');
            script.async = true;
            script.src = `https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=${config.ADSENSE_PUBLISHER_ID}`;
            script.crossOrigin = 'anonymous';
            document.head.appendChild(script);
        }
    </script>
    <script>
        // Simple Analytics Tracker
        async function trackConversion(format) {
            try {
                // Check if analytics is enabled in config
                if (!window.appConfig?.ENABLE_ANALYTICS) {
                    return;
                }

                // Get user's approximate location based on timezone
                const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                const timezoneParts = timezone.split('/');
                const country = timezoneParts.length > 1 ? timezoneParts[0] : 'Unknown';

                // Send to our logging API endpoint from config
                const response = await fetch(window.appConfig.ANALYTICS_API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        format: format,
                        country: country,
                        timestamp: new Date().getTime(),
                    }),
                });

                if (response.ok) {
                    console.log('âœ“ Conversion tracked');
                } else {
                    console.log('Conversion tracking failed (offline or network issue - this is ok)');
                }
            } catch (error) {
                // Silently fail - don't disrupt user experience
                console.log('Tracking unavailable:', error.message);
            }
        }

        // Reinitialize AdSense ads after page loads
        window.addEventListener('load', function() {
            if (window.adsbygoogle) {
                (adsbygoogle = window.adsbygoogle || []).push({});
            }
        });

        // Dark Mode Toggle
        const themeToggle = document.getElementById('themeToggle');
        const htmlElement = document.documentElement;

        // Load saved theme
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.innerHTML = '<i class="bi bi-sun-fill"></i>';
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            themeToggle.innerHTML = document.body.classList.contains('dark-mode')
                ? '<i class="bi bi-sun-fill"></i>'
                : '<i class="bi bi-moon-fill"></i>';
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        });

        // Alert Messages
        function showAlert(message, type = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Drag and Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        let uploadedFile = null;
        let uploadedFileName = null;

        dropZone.addEventListener('click', () => fileInput.click());

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            dropZone.classList.add('dragover');
        }

        function unhighlight(e) {
            dropZone.classList.remove('dragover');
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            handleFiles(files);
        }

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length === 0) return;

            const file = files[0];
            const validTypes = ['text/plain', 'text/html'];
            const MAX_FILE_SIZE = window.appConfig.MAX_FILE_SIZE;

            if (!validTypes.includes(file.type)) {
                showAlert('Please upload a TXT or HTML file', 'danger');
                fileInput.value = '';
                return;
            }

            if (file.size > MAX_FILE_SIZE) {
                showAlert(`File size exceeds ${(MAX_FILE_SIZE / 1024 / 1024).toFixed(0)}MB limit. Your file is ${(file.size / 1024 / 1024).toFixed(2)}MB.`, 'danger');
                fileInput.value = '';
                return;
            }

            uploadedFile = file;
            // Extract filename without extension for PDF name
            uploadedFileName = file.name.replace(/\.[^/.]+$/, '');
            displayFile(file);

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                document.getElementById('textArea').value = content;
                detectFormat(content);
            };
            reader.readAsText(file);
        }

        function displayFile(file) {
            fileList.innerHTML = `
                <div class="file-item">
                    <div>
                        <i class="bi bi-file-earmark"></i>
                        <strong>${file.name}</strong>
                        <div class="text-muted" style="font-size: 0.85rem;">${(file.size / 1024).toFixed(2)} KB</div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="clearFile()">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
        }

        function clearFile() {
            uploadedFile = null;
            uploadedFileName = null;
            fileInput.value = '';
            fileList.innerHTML = '';
        }

        // Auto-detect content format
        function detectFormat(content) {
            // Check for HTML tags
            const htmlPattern = /<[^>]+>/g;
            const hasHTMLTags = htmlPattern.test(content);
            
            const format = hasHTMLTags ? 'HTML' : 'Plain Text';
            window.detectedFormat = hasHTMLTags ? 'html' : 'text';
            document.getElementById('formatDetected').textContent = format;
        }

        // Detect format on textarea input
        document.getElementById('textArea').addEventListener('input', () => {
            detectFormat(document.getElementById('textArea').value);
        });

        // Convert to PDF
        document.getElementById('convertBtn').addEventListener('click', convertToPDF);

        async function convertToPDF() {
            const textContent = document.getElementById('textArea').value.trim();
            const format = window.detectedFormat || 'text';
            
            // User-entered title takes precedence
            const userEnteredTitle = document.getElementById('pdfTitle').value.trim();
            let pdfTitle = userEnteredTitle;
            
            // If no title entered, use uploaded filename if available
            if (!pdfTitle && uploadedFileName && window.appConfig.USE_UPLOADED_FILENAME) {
                pdfTitle = uploadedFileName;
            }
            
            // Final fallback to default
            if (!pdfTitle) {
                pdfTitle = window.appConfig.DEFAULT_TEXT_PDF_NAME || 'document';
            }
            
            const MAX_TEXT_SIZE = window.appConfig.MAX_TEXT_SIZE;

            if (!textContent) {
                showAlert('Please enter content or upload a file', 'warning');
                return;
            }

            if (new Blob([textContent]).size > MAX_TEXT_SIZE) {
                showAlert(`Content exceeds ${(MAX_TEXT_SIZE / 1024 / 1024).toFixed(0)}MB limit. Your content is ${(new Blob([textContent]).size / 1024 / 1024).toFixed(2)}MB.`, 'warning');
                return;
            }

            const convertBtn = document.getElementById('convertBtn');
            convertBtn.disabled = true;
            convertBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Converting...';

            try {
                if (format === 'html') {
                    await convertHTMLToPDF(textContent, pdfTitle);
                } else {
                    await convertTextToPDF(textContent, pdfTitle);
                }
                
                // Track the conversion
                trackConversion(format === 'html' ? 'HTML to PDF' : 'Text to PDF');
                
                showAlert('PDF created successfully!', 'success');
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error creating PDF: ' + error.message, 'danger');
            } finally {
                convertBtn.disabled = false;
                convertBtn.innerHTML = '<i class="bi bi-download"></i> Convert to PDF';
            }
        }

        async function convertTextToPDF(text, title) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 15;
            const lineHeight = 5;
            const maxWidth = pageWidth - (2 * margin);

            // Set font
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(11);

            // Split text into lines
            const lines = doc.splitTextToSize(text, maxWidth);

            let yPosition = margin;

            lines.forEach((line) => {
                if (yPosition > pageHeight - margin) {
                    doc.addPage();
                    yPosition = margin;
                }
                doc.text(line, margin, yPosition);
                yPosition += lineHeight;
            });

            doc.save(title + '.pdf');
        }

        // Extract CSS from HTML and inject it into container
        function extractAndApplyStyles(html, container) {
            // Extract all style tags
            const styleMatches = html.match(/<style[^>]*>([\s\S]*?)<\/style>/gi) || [];
            
            styleMatches.forEach(styleTag => {
                const styleContent = styleTag.replace(/<\/?style[^>]*>/gi, '');
                const style = document.createElement('style');
                style.textContent = styleContent;
                container.appendChild(style);
            });

            // Also extract link stylesheets if any
            const linkMatches = html.match(/<link[^>]*rel=["\']?stylesheet["\']?[^>]*>/gi) || [];
            linkMatches.forEach(linkTag => {
                const hrefMatch = linkTag.match(/href=["\']?([^"\'\s>]+)["\']?/);
                if (hrefMatch && hrefMatch[1]) {
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = hrefMatch[1];
                    container.appendChild(link);
                }
            });
        }

        // Wait for stylesheets to load with timeout
        async function waitForStylesheets(container, timeout = 10000) {
            const links = container.querySelectorAll('link[rel="stylesheet"]');
            if (links.length === 0) return;

            const loadPromises = Array.from(links).map((link) => {
                return new Promise((resolve) => {
                    const timer = setTimeout(() => {
                        console.warn(`Stylesheet timeout: ${link.href}`);
                        resolve(); // Resolve anyway to not block conversion
                    }, timeout);

                    const onLoad = () => {
                        clearTimeout(timer);
                        resolve();
                    };

                    link.onload = onLoad;
                    link.onerror = onLoad; // Resolve on error too
                });
            });

            await Promise.race([
                Promise.all(loadPromises),
                new Promise(resolve => setTimeout(resolve, timeout))
            ]);
        }

        // Sanitize HTML to remove problematic elements and external dependencies
        function sanitizeHTMLForPDF(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;

            // Remove script tags (they won't execute in canvas anyway)
            temp.querySelectorAll('script').forEach(el => el.remove());

            // Remove noscript tags
            temp.querySelectorAll('noscript').forEach(el => el.remove());

            // Handle iframes - try to extract visible content, fall back to placeholder only for external embeds
            temp.querySelectorAll('iframe').forEach(el => {
                // Keep the iframe element - html2canvas may be able to render it
                // Only show placeholder if it's an external embed (YouTube, etc.)
                const src = el.getAttribute('src') || '';
                const isExternalEmbed = /youtube|vimeo|dailymotion|facebook|instagram|twitter|tiktok/i.test(src);
                
                if (isExternalEmbed) {
                    const placeholder = document.createElement('div');
                    placeholder.style.border = '2px dashed #999';
                    placeholder.style.padding = '15px';
                    placeholder.style.backgroundColor = '#f9f9f9';
                    placeholder.style.textAlign = 'center';
                    placeholder.style.color = '#666';
                    placeholder.style.minHeight = '100px';
                    placeholder.style.display = 'flex';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.justifyContent = 'center';
                    placeholder.innerHTML = `<span>[External embed: ${src.split('/')[2] || 'embedded content'}]</span>`;
                    el.replaceWith(placeholder);
                }
                // Keep local iframes as-is for rendering
            });

            // Handle video and audio tags - show info instead of removing
            temp.querySelectorAll('video').forEach(el => {
                const poster = el.getAttribute('poster');
                const placeholder = document.createElement('div');
                placeholder.style.border = '2px dashed #999';
                placeholder.style.padding = '15px';
                placeholder.style.backgroundColor = '#f0f0f0';
                placeholder.style.textAlign = 'center';
                placeholder.style.color = '#333';
                if (poster) {
                    placeholder.style.backgroundImage = `url('${poster}')`;
                    placeholder.style.backgroundSize = 'cover';
                    placeholder.style.backgroundPosition = 'center';
                    placeholder.style.minHeight = '200px';
                } else {
                    placeholder.style.minHeight = '100px';
                    placeholder.style.display = 'flex';
                    placeholder.style.alignItems = 'center';
                    placeholder.style.justifyContent = 'center';
                }
                const text = document.createElement('span');
                text.style.backgroundColor = 'rgba(255,255,255,0.9)';
                text.style.padding = '10px';
                text.style.borderRadius = '4px';
                text.textContent = '[Video content]';
                placeholder.appendChild(text);
                el.replaceWith(placeholder);
            });

            temp.querySelectorAll('audio').forEach(el => {
                const placeholder = document.createElement('div');
                placeholder.style.border = '2px dashed #999';
                placeholder.style.padding = '15px';
                placeholder.style.backgroundColor = '#f9f9f9';
                placeholder.style.textAlign = 'center';
                placeholder.style.color = '#666';
                placeholder.style.minHeight = '60px';
                placeholder.style.display = 'flex';
                placeholder.style.alignItems = 'center';
                placeholder.style.justifyContent = 'center';
                placeholder.textContent = '[Audio content]';
                el.replaceWith(placeholder);
            });

            // Remove style attributes that use external background-images (prevent blocking)
            temp.querySelectorAll('[style*="background-image"]').forEach(el => {
                const style = el.getAttribute('style');
                const cleanStyle = style.replace(/background-image\s*:\s*url\([^)]*\)/gi, '');
                if (cleanStyle.trim()) {
                    el.setAttribute('style', cleanStyle);
                } else {
                    el.removeAttribute('style');
                }
            });

            // Make hidden elements visible for PDF rendering
            temp.querySelectorAll('[style*="display:none"], [style*="visibility:hidden"], [hidden]').forEach(el => {
                el.removeAttribute('hidden');
                const style = el.getAttribute('style') || '';
                const cleanStyle = style
                    .replace(/display\s*:\s*none\s*!?;?/gi, 'display: block;')
                    .replace(/visibility\s*:\s*hidden\s*!?;?/gi, 'visibility: visible;');
                el.setAttribute('style', cleanStyle);
            });

            return temp.innerHTML;
        }

        // Extract and render JavaScript data as static HTML with better styling
        async function extractAndRenderData(html) {
            // Try to extract the messages variable from script tags
            const messagesMatch = html.match(/const\s+messages\s*=\s*(\[[\s\S]*?\]);/);
            
            if (messagesMatch) {
                try {
                    // Parse the messages array
                    const messages = eval(messagesMatch[1]);
                    
                    // Create styled HTML from messages
                    let staticContent = `
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background: #f7f7f9; }
                            .transcript { max-width: 900px; margin: 0 auto; }
                            h1 { color: #333; margin-bottom: 20px; font-size: 24px; }
                            .message { 
                                margin-bottom: 12px; 
                                padding: 12px 15px; 
                                border-radius: 8px; 
                                word-wrap: break-word;
                            }
                            .message.bot {
                                background: rgb(116, 39, 116);
                                color: white;
                                margin-right: 40px;
                            }
                            .message.user {
                                background: white;
                                color: #000;
                                margin-left: 40px;
                                border: 1px solid #ddd;
                            }
                            .message-header {
                                font-weight: 700;
                                font-size: 12px;
                                margin-bottom: 4px;
                                opacity: 0.9;
                            }
                            .message-time {
                                font-size: 10px;
                                opacity: 0.7;
                                margin-top: 4px;
                            }
                            .message-content {
                                font-size: 13px;
                                line-height: 1.4;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="transcript">
                            <h1>Chat Transcript</h1>
                    `;
                    
                    messages.forEach(msg => {
                        // Skip control messages and system messages
                        if (msg.isControlMessage || (msg.tags && msg.tags.includes('system'))) {
                            return;
                        }
                        
                        const displayName = msg.from?.user?.displayName || msg.from?.application?.displayName || 'User';
                        const content = msg.content || '';
                        const timestamp = msg.created ? new Date(msg.created).toLocaleTimeString("en-us", { year: "numeric", month:"numeric", day:"numeric", hour: "2-digit", minute: "2-digit"}) : '';
                        
                        // Determine if it's a bot or user message
                        const isBot = msg.from?.user ? true : false;
                        const messageClass = isBot ? 'bot' : 'user';
                        
                        if (content) {
                            staticContent += `
                            <div class="message ${messageClass}">
                                <div class="message-header">${displayName}</div>
                                <div class="message-content">${content}</div>
                                <div class="message-time">${timestamp}</div>
                            </div>
                            `;
                        }
                    });
                    
                    staticContent += `
                        </div>
                    </body>
                    </html>
                    `;
                    return staticContent;
                } catch (e) {
                    console.warn('Could not extract messages:', e);
                    return null;
                }
            }
            
            return null;
        }

        // Enhanced HTML to PDF conversion with full styling support
        async function convertHTMLToCanvasPDF(html, title) {
            const { jsPDF } = window.jspdf;

            let htmlToConvert = html;
            
            // Try to extract and render data from JavaScript
            const staticHtml = await extractAndRenderData(html);
            if (staticHtml) {
                console.log('Using extracted static HTML with styling');
                htmlToConvert = staticHtml;
                showAlert('Rendering chat transcript from data...', 'info');
            }

            // Sanitize HTML to remove problematic elements
            htmlToConvert = sanitizeHTMLForPDF(htmlToConvert);

            // Create a temporary container with full HTML structure
            const container = document.createElement('div');
            
            // If it's a full HTML document, use it as-is
            if (htmlToConvert.toLowerCase().includes('</html>')) {
                container.innerHTML = htmlToConvert;
            } else {
                // Otherwise wrap it
                container.innerHTML = `
                    <html>
                    <head>
                        <meta charset="UTF-8">
                        <style>
                            * { margin: 0; padding: 0; box-sizing: border-box; }
                            body { font-family: Arial, sans-serif; padding: 20px; background: white; }
                        </style>
                    </head>
                    <body>${htmlToConvert}</body>
                    </html>
                `;
            }
            
            container.style.position = 'absolute';
            container.style.left = '-9999px';
            container.style.top = '0';
            container.style.display = 'block';
            document.body.appendChild(container);

            // Extract styles from original HTML
            extractAndApplyStyles(html, container);

            // Get the body element to measure
            const bodyElement = container.querySelector('body') || container;
            bodyElement.style.width = '1200px';
            bodyElement.style.margin = '0';
            bodyElement.style.padding = '20px';
            bodyElement.style.backgroundColor = '#fff';
            
            // Wait for stylesheets to load with timeout
            await waitForStylesheets(container, 5000);
            
            // Wait for reflow and style application
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Ensure all images are loaded with timeout
            const images = container.querySelectorAll('img');
            const imageLoadPromises = Array.from(images).map(img => {
                return new Promise((resolve) => {
                    const timer = setTimeout(resolve, 3000); // 3 second timeout per image
                    const cleanup = () => {
                        clearTimeout(timer);
                        resolve();
                    };
                    
                    if (img.complete) {
                        resolve();
                    } else {
                        img.onload = cleanup;
                        img.onerror = cleanup;
                    }
                });
            });

            if (imageLoadPromises.length > 0) {
                await Promise.race([
                    Promise.all(imageLoadPromises),
                    new Promise(resolve => setTimeout(resolve, 5000)) // Overall 5 second limit
                ]);
            }

            // Wait for styling to be applied
            await new Promise(resolve => setTimeout(resolve, 500));

            try {
                // Use html2canvas with optimized settings for complex HTML
                const canvas = await html2canvas(container, {
                    scale: 2,
                    useCORS: false, // Disable CORS to avoid hanging on external resources
                    allowTaint: true, // Allow tainted canvas (images that fail to load)
                    backgroundColor: '#ffffff',
                    logging: false,
                    windowWidth: 1200,
                    windowHeight: Math.max(bodyElement.scrollHeight, 1000), // Ensure minimum height
                    timeout: 30000, // 30 second timeout
                    onclone: (clonedDocument) => {
                        const clonedBody = clonedDocument.querySelector('body');
                        if (clonedBody) {
                            clonedBody.style.margin = '0';
                            clonedBody.style.padding = '20px';
                            clonedBody.style.width = '1200px';
                            // Ensure no hidden elements
                            clonedBody.style.display = 'block';
                        }
                        // Remove scripts from cloned document to prevent issues
                        const scripts = clonedDocument.querySelectorAll('script');
                        scripts.forEach(script => script.remove());
                    }
                });

                if (canvas.width === 0 || canvas.height === 0) {
                    throw new Error('Canvas rendering resulted in empty image. Check your HTML content.');
                }

                const imgData = canvas.toDataURL('image/png', 0.95);
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 10;
                const imgWidth = pageWidth - (2 * margin);
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                // Fixed pagination logic
                let heightLeft = imgHeight;
                let position = 0;

                // Add first page
                pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                heightLeft -= (pageHeight - 2 * margin);

                // Add subsequent pages
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight + margin;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                    heightLeft -= (pageHeight - 2 * margin);
                }

                const pageCount = Math.ceil(imgHeight / (pageHeight - 2 * margin));
                pdf.save(title + '.pdf');
                console.log('âœ“ PDF generated successfully with', pageCount, 'page(s)');
                showAlert(`PDF created successfully (${pageCount} page${pageCount > 1 ? 's' : ''})`, 'success');
            } catch (error) {
                console.error('PDF conversion error:', error);
                const errorMsg = error.message || 'Unknown error';
                showAlert(`Failed to convert HTML: ${errorMsg}`, 'danger');
                throw new Error(`HTML to PDF conversion failed: ${errorMsg}`);
            } finally {
                document.body.removeChild(container);
            }
        }

        async function convertHTMLToPDF(html, title) {
            // Use client-side conversion for all HTML
            await convertHTMLToCanvasPDF(html, title);
        }

        // Clear Button
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.getElementById('textArea').value = '';
            document.getElementById('pdfTitle').value = '';
            document.getElementById('formatDetected').textContent = 'Plain Text';
            window.detectedFormat = 'text';
            clearFile();
        });
    </script>
</body>
</html>
